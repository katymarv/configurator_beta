{"version":3,"file":"receiver_msp.js","sources":["../../../src/js/tabs/receiver_msp.js"],"sourcesContent":["import '../jqueryPlugins';\nimport windowWatcherUtil from \"../utils/window_watchers\";\nimport $ from 'jquery';\n\n// This is a hack to get the i18n var of the parent, but the i18n.localizePage not works\n// It seems than when node opens a new window, the module \"context\" is different, so the i18n var is not initialized\nconst i18n = opener.i18n;\n\nconst css_dark = [\n    '/css/dark-theme.css',\n];\n\nconst CHANNEL_MIN_VALUE = 1000;\nconst CHANNEL_MID_VALUE = 1500;\nconst CHANNEL_MAX_VALUE = 2000;\n\n    // What's the index of each channel in the MSP channel list?\nconst channelMSPIndexes = {\n    Roll: 0,\n    Pitch: 1,\n    Throttle: 2,\n    Yaw: 3,\n    Aux1: 4,\n    Aux2: 5,\n    Aux3: 6,\n    Aux4: 7,\n};\n\n    // Set reasonable initial stick positions (Mode 2)\nconst stickValues = {\n    Throttle: CHANNEL_MIN_VALUE,\n    Pitch: CHANNEL_MID_VALUE,\n    Roll: CHANNEL_MID_VALUE,\n    Yaw: CHANNEL_MID_VALUE,\n    Aux1: CHANNEL_MIN_VALUE,\n    Aux2: CHANNEL_MIN_VALUE,\n    Aux3: CHANNEL_MIN_VALUE,\n    Aux4: CHANNEL_MIN_VALUE,\n};\n\n    // First the vertical axis, then the horizontal:\nconst gimbals = [\n    [\"Throttle\", \"Yaw\"],\n    [\"Pitch\", \"Roll\"],\n];\n\nlet gimbalElems;\nlet sliderElems;\nlet enableTX = false;\n\nconst watchers = {\n    darkTheme: (val) => {\n        if (val) {\n            applyDarkTheme();\n        } else {\n            applyNormalTheme();\n        }\n    },\n};\n\nfunction transmitChannels() {\n    const channelValues = [0, 0, 0, 0, 0, 0, 0, 0];\n\n    if (!enableTX) {\n        return;\n    }\n\n    for (const stickName in stickValues) {\n        channelValues[channelMSPIndexes[stickName]] = stickValues[stickName];\n    }\n\n    // Callback given to us by the window creator so we can have it send data over MSP for us:\n    if (!window.setRawRx(channelValues)) {\n        // MSP connection has gone away\n        chrome.app.window.current().close();\n    }\n}\n\nfunction stickPortionToChannelValue(portion) {\n    portion = Math.min(Math.max(portion, 0.0), 1.0);\n\n    return Math.round(portion * (CHANNEL_MAX_VALUE - CHANNEL_MIN_VALUE) + CHANNEL_MIN_VALUE);\n}\n\nfunction channelValueToStickPortion(channel) {\n    return (channel - CHANNEL_MIN_VALUE) / (CHANNEL_MAX_VALUE - CHANNEL_MIN_VALUE);\n}\n\nfunction updateControlPositions() {\n    for (const stickName in stickValues) {\n        const stickValue = stickValues[stickName];\n\n        // Look for the gimbal which corresponds to this stick name\n        for (const gimbalIndex in gimbals) {\n            const gimbal = gimbals[gimbalIndex],\n                gimbalElem = gimbalElems.get(gimbalIndex),\n                gimbalSize = $(gimbalElem).width(),\n                stickElem = $(\".control-stick\", gimbalElem);\n\n            if (gimbal[0] === stickName) {\n                stickElem.css('top', `${(1.0 - channelValueToStickPortion(stickValue)) * gimbalSize}px`);\n                break;\n            } else if (gimbal[1] === stickName) {\n                stickElem.css('left', `${channelValueToStickPortion(stickValue) * gimbalSize}px`);\n                break;\n            }\n        }\n    }\n}\n\nfunction handleGimbalMouseDrag(e) {\n    const gimbal = $(gimbalElems.get(e.data.gimbalIndex)),\n        gimbalOffset = gimbal.offset(),\n        gimbalSize = gimbal.width();\n\n    stickValues[gimbals[e.data.gimbalIndex][0]] = stickPortionToChannelValue(1.0 - (e.pageY - gimbalOffset.top) / gimbalSize);\n    stickValues[gimbals[e.data.gimbalIndex][1]] = stickPortionToChannelValue((e.pageX - gimbalOffset.left) / gimbalSize);\n\n    updateControlPositions();\n}\n\nfunction localizePage() {\n    $('[i18n]:not(.i18n-replaced)').each(function() {\n        const element = $(this);\n\n        element.html(i18n.getMessage(element.attr('i18n')));\n        element.addClass('i18n-replaced');\n    });\n}\n\nfunction localizeAxisNames() {\n    for (const gimbalIndex in gimbals) {\n        const gimbal = gimbalElems.get(gimbalIndex);\n\n        $(\".gimbal-label-vert\", gimbal).text(i18n.getMessage(`controlAxis${gimbals[gimbalIndex][0]}`));\n        $(\".gimbal-label-horz\", gimbal).text(i18n.getMessage(`controlAxis${gimbals[gimbalIndex][1]}`));\n    }\n\n    for (let sliderIndex = 0; sliderIndex < 4; sliderIndex++) {\n        $(\".slider-label\", sliderElems.get(sliderIndex)).text(i18n.getMessage(`controlAxisAux${sliderIndex + 1}`));\n    }\n}\n\nfunction applyDarkTheme() {\n    css_dark.forEach((el) => $(`link[href=\"${el}\"]`).prop('disabled', false));\n}\n\nfunction applyNormalTheme() {\n    css_dark.forEach((el) => $(`link[href=\"${el}\"]`).prop('disabled', true));\n}\n\n$(\".button-enable .btn\").on(\"click\", function() {\n    const shrinkHeight = $(\".warning\").height();\n\n    $(\".warning\").slideUp(\"short\", function() {\n        chrome.app.window.current().innerBounds.minHeight -= shrinkHeight;\n        chrome.app.window.current().innerBounds.height -= shrinkHeight;\n        chrome.app.window.current().innerBounds.maxHeight -= shrinkHeight;\n    });\n\n    enableTX = true;\n});\n\ngimbalElems = $(\".control-gimbal\");\nsliderElems = $(\".control-slider\");\n\ngimbalElems.each(function(gimbalIndex) {\n    $(this).on('mousedown', {gimbalIndex: gimbalIndex}, function(e) {\n        if (e.button === 0) { // Only move sticks on left mouse button\n            handleGimbalMouseDrag(e);\n\n            $(window).on('mousemove', {gimbalIndex: gimbalIndex}, handleGimbalMouseDrag);\n        }\n    });\n});\n\n$(\".slider\", sliderElems).each(function(sliderIndex) {\n    const initialValue = stickValues[`Aux${sliderIndex + 1}`];\n\n    $(this)\n        .noUiSlider({\n            start: initialValue,\n            range: {\n                min: CHANNEL_MIN_VALUE,\n                max: CHANNEL_MAX_VALUE,\n            },\n        }).on('slide change set', function(e, value) {\n            value = Math.round(parseFloat(value));\n\n            stickValues[`Aux${(sliderIndex + 1)}`] = value;\n\n            $(\".tooltip\", this).text(value);\n        });\n\n    $(this).append('<div class=\"tooltip\"></div>');\n\n    $(\".tooltip\", this).text(initialValue);\n});\n\n/*\n * Mouseup handler needs to be bound to the window in order to receive mouseup if mouse leaves window.\n */\n$(window).on(\"mouseup\", function(e) {\n    $(this).off('mousemove', handleGimbalMouseDrag);\n});\n\nwindowWatcherUtil.bindWatchers(window, watchers);\n\nlocalizePage();\nlocalizeAxisNames();\n\nupdateControlPositions();\n\nsetInterval(transmitChannels, 50);\n"],"names":[],"mappings":"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"}